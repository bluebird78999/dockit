<meta charset="utf-8"><div id="_mx__md_container"> <div id="_mx__gotop">Top</div><style type="text/css">#_mx__md_container{
  font-family: 'microsoft yahei',Verdana,Arial,Helvetica,sans-serif;
  font-size:14px;
  max-width:900px;
	margin-left:auto;
	margin-right:auto;
}
.hljs-keyword{
  color: #F92672;
}
.hljs-built_in{
  color: #0071A6;
}

/*code*/
._mx__code_pre{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  background-color: #F2F2F2 !important;
  overflow-x: auto;
  /*border:1px solid #1D1E19;*/
  padding:15px;
  /*border-radius:3px;*/
}
._mx__code_pre code{
  /*color: #F6F7EE;*/
}
/*code span*/
._mx__code_span{
  display: inline-block;
  padding:3px;
  color: #5151BE;
	background-color: #F5F6FA;
	border:1px solid #CBD2E0;
	border-radius:2px;
	margin-left: 3px;
	margin-right:3px;
}
/*heading*/
._mx__heading{
  color: #434343;
}

._mx__heading_border{
	border-bottom: 1px solid #D5D5D5;
	color: #262626;
	display: block;
	height:92px;
	line-height:92px;
}
/*._mx__heading:hover{
  color:#3498db;
}*/
/*paragraph*/
._mx__paragraph{
  color: #4e5665;
  font-size: 14px;
	line-height:22px;
}

/*link*/
._mx__link{
  color: #317FBD;
}

/*image*/
._mx__image{
  max-width:800px;
	max-height: 600px;
	display: inline-block;
}
._mx__image_container{
	max-width:900px;
	text-align: center;
	margin-top:10px;
	margin-bottom:10px;
}
/*作者信息*/
._mx__time{
	position: relative;
	top: -45px;
	width: 165px;
	float: right;
	color: #A9A9A9;
	font-size:13px;
}

/*api*/
._mx__api_stable{
	height: 40px;
	background-color:red;
	line-height:40px;
	color: #fff;
	padding-left:10px;
}

/*toc*/
._mx__toc{
	position: relative;
	right:30px;
	width:200px;
	border:1px solid #D5D5D5;
	background-color: #fff;
	float: right;
	margin-right: -200px;
}

._mx__toc_ul{
	list-style: none;
	margin-left: -30px;
}
._mx__toc_ul a{
	text-decoration:none;
	color: #2468B2;
}

._mx_toc_level_3{
	margin-left:10px;
}

._mx_toc_level_4{
	margin-left:20px;
}

._mx_toc_level_5{
	margin-left:30px;
}

._mx_toc_level_6{
	margin-left:40px;
}

#_mx__gotop{
	position: fixed;
	width:40px;
	height:40px;
	border:1px solid #ddd;
	border-radius:20px;
	bottom:100px;
	right: 10px;
	text-align: center;
	line-height:40px;
	cursor:pointer;
	display: none;
}</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
<h1 class="_mx__heading _mx__heading_border"><a name=" class="_mx__heading" onclick="addAnchor('第3篇 初始化工程')"><a name="第3篇 初始化工程" class="anchor" href="#第3篇 初始化工程"><span class="header-link"></span></a>第3篇 初始化工程</h1><div class="_mx__time">update time: 2016/10/12
</div><div class="_mx__paragraph">初始化工程是一个项目开发的第一步。迈出了这一步，你就成功了一半。我相信大部分同学构建了一个项目，是会拼着老命写完的（逃...）。      </div><div class="_mx__paragraph"> 这里，我尝试用简单的方式来说明一个工程的构建。然后，再将简单的方式工程化（复杂化），最后拼凑成目前weex开源的代码结构。   </div><h2 class="_mx__heading" onclick="addAnchor('安装weex-toolkit')"><a name="安装weex-toolkit" class="anchor" href="#安装weex-toolkit"><span class="header-link"></span></a>安装weex-toolkit</h2><div class="_mx__paragraph"><strong>style</strong> 0.8 [mx_api_stable]       </div><div class="_mx__paragraph">weex-toolkit是一个很好的工具供我们工程构建。首先，第一步是安装该工具：   </div><pre class="_mx__code_pre" id="__aa"><code><a><span class="hljs-meta"><span class="hljs-meta-keyword">$npm</span> install -g weex-toolkit       </span></a></code></pre><div class="_mx__paragraph">测试weex-toolkit是否安装成功，可以使用如下命令测试：       </div><pre class="_mx__code_pre" id="__aa"><code><a>$ weex --version       
info <span class="hljs-number">0.4</span><span class="hljs-number">.4</span>      </a></code></pre><div class="_mx__paragraph">如果显示版本号即为成功。         </div><h2 class="_mx__heading" onclick="addAnchor('创建项目')"><a name="创建项目" class="anchor" href="#创建项目"><span class="header-link"></span></a>创建项目</h2><div class="_mx__paragraph">这里，我们不再使用<span class="_mx__code_span">weex</span> 跑一个文件的形式。我们需要一个较为完整的方案，因此，这里采用weex init命令创建项目。         </div><div class="_mx__paragraph">首先，我们创建一个目录存放我们的项目，启动命令行：     </div><pre class="_mx__code_pre" id="__aa"><code><a>$ mkdir test      
$ cd test    
$ weex init 
    <span class="hljs-comment">//下面一路空格即可</span>
    prompt: Project Name:  (test) 
    file: <span class="hljs-selector-class">.gitignore</span> created.
    file: README<span class="hljs-selector-class">.md</span> created.
    file: index<span class="hljs-selector-class">.html</span> created.
    file: package<span class="hljs-selector-class">.json</span> created.
    file: src/main<span class="hljs-selector-class">.we</span> created.
    file: webpack<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span> created.     </a></code></pre><h2 class="_mx__heading" onclick="addAnchor('跑起项目')"><a name="跑起项目" class="anchor" href="#跑起项目"><span class="header-link"></span></a>跑起项目</h2><div class="_mx__paragraph">首先，我们需要安装依赖。以后大家看到package.json文件，就可以直接npm i 安装模块了。<strong>但是</strong>, 有些项目需要确保下载的依赖和目前的版本一致，这就是工程一致性的后话了。           </div><pre class="_mx__code_pre" id="__aa"><code><a>$ npm <span class="hljs-keyword">install</span> </a></code></pre><div class="_mx__paragraph">依赖安装完成，启动项目编译。</div><pre class="_mx__code_pre" id="__aa"><code><a>$ npm <span class="hljs-keyword">run</span><span class="bash"> dev       </span></a></code></pre><div class="_mx__paragraph"> 启动轻量服务器。    </div><pre class="_mx__code_pre" id="__aa"><code><a> $ npm <span class="hljs-keyword">run</span><span class="bash"> serve            </span></a></code></pre><div class="_mx__paragraph"> 这时，打开浏览器，输入<a class="_mx__link" title="null" href="http://127.0.0.1:8080" >http://127.0.0.1:8080</a>, 就会看到如下界面效果:       </div><div class="_mx__paragraph"> <div class="_mx__image_container"><img src="http://alinode-assets.oss-cn-hangzhou.aliyuncs.com/6a95c4dc-b01d-4585-b574-7e706e2cc03e.png" alt="阿里云" class="_mx__image" style="width:600px;height:320px;"/></div>          </div><h2 class="_mx__heading" onclick="addAnchor('npm run dev干了什么事儿')"><a name="npm run dev干了什么事儿" class="anchor" href="#npm run dev干了什么事儿"><span class="header-link"></span></a>npm run dev干了什么事儿</h2><div class="_mx__paragraph">当然这一些都是node/npm的常识了。首先，我们打开package.json文件。可以看到如下代码：     </div><div class="_mx__paragraph"> 我们可以看到scripts里面包含了build、dev、serve、test四个属性。例如dev属性,npm run dev实际上相当于 webpack --watch。即等同开发者做了这件事:   </div><pre class="_mx__code_pre" id="__aa"><code><a> $ webpack <span class="hljs-comment">--watch        </span></a></code></pre><div class="_mx__paragraph"> ok，看到这里明白了。npm run dev调用了webpack。那么，webpack实际上是执行了配置文件。webpack默认是webpack.config.js作为配置文件的。所以看一下webpack.config.js中的内容。       </div><div class="_mx__paragraph">  这个文件比较好理解。一个是引入了webpack的配置，一个是使用了weex-loader模块。<br>  entry属性是表示入口文件，output表示输出文件，默认输出到dist问价夹。所有打开dist就可以看到一个打包完成的main.js文件。      </div><h2 class="_mx__heading" onclick="addAnchor('npm run serve')"><a name="npm run serve" class="anchor" href="#npm run serve"><span class="header-link"></span></a>npm run serve</h2><div class="_mx__paragraph">这个同上，不做展开，主要是做一个服务器，提供浏览器访问静态资源。     </div><h2 class="_mx__heading" onclick="addAnchor('入口文件index.html')"><a name="入口文件index.html" class="anchor" href="#入口文件index.html"><span class="header-link"></span></a>入口文件index.html</h2><div class="_mx__paragraph">是时候，去了解我们index.html文件干了一件啥事。其实，index.html就是页面的入口文件。具体大码如下：            </div><pre class="_mx__code_pre" id="__aa"><code><a><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Weex HTML5<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-capable"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"yes"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-status-bar-style"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"black"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-touch-fullscreen"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"yes"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no, email=no"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span>, <span class="hljs-selector-id">#weex</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./node_modules/weex-html5/dist/weex.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"weex"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * Init weex instance depending on the url params.
   * There are three ways to load weex bundles, depends on the
   * parameter 'loader' in the url:
   *
   *   + xhr: use XMLHttpRequest. Parameter 'page' should be
   *   the bundle's url.
   *   + source: use the transformed code itself. 'page' should
   *   be the transformed weex bundle.
   *
   * @param {String} bundle - It has different meaning depends on
   *   the type of loader.
   */</span>
  (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrlParam</span> (<span class="hljs-params">key</span>) </span>{
      <span class="hljs-keyword">var</span> reg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'[?|&amp;]'</span> + key + <span class="hljs-string">'=([^&amp;]+)'</span>)
      <span class="hljs-keyword">var</span> match = location.search.match(reg)
      <span class="hljs-keyword">return</span> match &amp;&amp; match[<span class="hljs-number">1</span>]
    }

    <span class="hljs-keyword">var</span> loader = getUrlParam(<span class="hljs-string">'loader'</span>) || <span class="hljs-string">'xhr'</span>
    <span class="hljs-keyword">var</span> page = getUrlParam(<span class="hljs-string">'page'</span>) || <span class="hljs-string">'dist/main.js'</span>

    <span class="hljs-built_in">window</span>.weex.init({
      <span class="hljs-attr">appId</span>: location.href,
      <span class="hljs-attr">loader</span>: loader,
      <span class="hljs-attr">source</span>: page,
      <span class="hljs-attr">rootId</span>: <span class="hljs-string">'weex'</span>
    })
  })();
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></a></code></pre><div class="_mx__paragraph">作为入口和载体，htmk做了两件事：<br>1) 拿到页面的URL，根据page参数获得需要加载的js文件路径<br>2）初始化weex实例，加载文件。<br>此处文章可参考：<a class="_mx__link" title="null" href="http://alibaba.github.io/weex/doc/advanced/integrate-to-html5.html" >http://alibaba.github.io/weex/doc/advanced/integrate-to-html5.html</a>     </div><h2 class="_mx__heading" onclick="addAnchor('是否可以更好的理解weex github源码结构')"><a name="是否可以更好的理解weex github源码结构" class="anchor" href="#是否可以更好的理解weex github源码结构"><span class="header-link"></span></a>是否可以更好的理解weex github源码结构</h2><div class="_mx__paragraph">到这里，整个weex项目的来龙去脉，应该是比较清楚了。那么，回过头来看，weex开源代码如何构建，应该是件水到渠成的事了。比如看这段打包的配置代码：<a class="_mx__link" title="null" href="https://github.com/alibaba/weex/blob/dev/build/webpack.examples.config.js" >https://github.com/alibaba/weex/blob/dev/build/webpack.examples.config.js</a>          </div><pre class="_mx__code_pre" id="__aa"><code><a><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">var</span> entry = {};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">walk</span>(<span class="hljs-params">dir</span>) </span>{
  dir = dir || <span class="hljs-string">'.'</span>
  <span class="hljs-keyword">var</span> directory = path.join(__dirname, <span class="hljs-string">'../examples'</span>, dir);
  fs.readdirSync(directory)
    .forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
      <span class="hljs-keyword">var</span> fullpath = path.join(directory, file);
      <span class="hljs-keyword">var</span> stat = fs.statSync(fullpath);
      <span class="hljs-keyword">var</span> extname = path.extname(fullpath);
      <span class="hljs-keyword">if</span> (stat.isFile() &amp;&amp; extname === <span class="hljs-string">'.we'</span>) {
        <span class="hljs-keyword">var</span> name = path.join(<span class="hljs-string">'examples'</span>, <span class="hljs-string">'build'</span>, dir, path.basename(file, extname));
        entry[name] = fullpath + <span class="hljs-string">'?entry=true'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stat.isDirectory() &amp;&amp; file !== <span class="hljs-string">'build'</span> &amp;&amp; file !== <span class="hljs-string">'include'</span>) {
        <span class="hljs-keyword">var</span> subdir = path.join(dir, file);
        walk(subdir);
      }
    });
}

walk();

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">entry</span>: entry,
  <span class="hljs-attr">output</span> : {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'.'</span>,
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">loaders</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.we(\?[^?]+)?$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'weex'</span>
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js(\?[^?]+)?$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'weex?type=script'</span>
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css(\?[^?]+)?$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'weex?type=style'</span>
      }, 
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.html(\?[^?]+)?$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'weex?type=tpl'</span>
      }
    ]
  }
}</a></code></pre><div class="_mx__paragraph">就是编译examples目录下所有.we文件到build目录。代码可以细看，都是Node.js File System相关的API.               </div></div><script type="text/javascript">(function(win, undefined){
  var md_container = document.getElementById('_mx__md_container');
  var goTop = document.getElementById('_mx__gotop');

  function getPagePosition() { 
    var x = 0, y = 0;
    if(window.pageYOffset){   
      y = window.pageYOffset;    
      x = window.pageXOffset; 
    } else if(document.documentElement && document.documentElement.scrollTop){
      y = document.documentElement.scrollTop;    
      x = document.documentElement.scrollLeft; 
    } else if(document.body) {
      y = document.body.scrollTop;    
      x = document.body.scrollLeft;   
    } 
    return {x:x, y:y};
  }
  
  window.onscroll = function(){
    var pos = getPagePosition();
    if(pos.y > document.body.clientHeight){
      goTop.style.display = 'block';
    }else{
      goTop.style.display = 'none';
    }
  };

  //滚动到顶部
  goTop.onclick = function(){
    var pos = getPagePosition();
    var y = pos.y;
    var handle = setInterval(function(){
      y = y - 50;
      if(y <= 0){
        window.scrollTo(0, 0);
        clearInterval(handle);
      }else{
        window.scrollTo(0, y);
      }
    }, 1);
  };

  win.addAnchor = function(a){
    var url = window.location.href;
    if(window.location.href.indexOf('#') > -1){
      url = window.location.href.split('#')[0];
    }
    window.location.href = url + '#' + a;
  }

})(window);


</script>